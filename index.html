<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Priorities Survey</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        h1 {
            font-size: 2.5rem;
            margin: 20px 0;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            margin-bottom: 30px;
            text-align: center;
            opacity: 0.95;
        }

        .container {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
        }

        .plot-section {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .plot-title {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        canvas {
            display: block;
            cursor: crosshair;
            background: white;
            border-radius: 10px;
        }

        .status {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            min-height: 40px;
        }

        .success {
            background: rgba(72, 187, 120, 0.3);
        }

        .error {
            background: rgba(245, 101, 101, 0.3);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            .container {
                gap: 20px;
            }
            .plot-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <h1>üåç Shape Our Future üöÄ</h1>
    <p class="subtitle">Where should humanity focus? Click on each triangle to share your vision.</p>
    
    <div class="container">
        <div class="plot-section">
            <h2 class="plot-title">2025</h2>
            <canvas id="canvas2025" width="500" height="500"></canvas>
            <div id="status2025" class="status">Click on the triangle to cast your vote</div>
        </div>
        
        <div class="plot-section">
            <h2 class="plot-title">2075</h2>
            <canvas id="canvas2075" width="500" height="500"></canvas>
            <div id="status2075" class="status">Click on the triangle to cast your vote</div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://vvsmbbiovppehkydxhmu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2c21iYmlvdnBwZWhreWR4aG11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4Mjk3MDQsImV4cCI6MjA3NzQwNTcwNH0.efLojggzexktrFuSAiaZajIxdVmNLgcC17Dmn_nABNM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        class TernaryPlot {
            constructor(canvasId, year, statusId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.year = year;
                this.statusEl = document.getElementById(statusId);
                this.size = 500;
                this.padding = 80;
                this.height = (Math.sqrt(3) / 2) * (this.size - 2 * this.padding);
                
                this.labels = [
                    'Maximising AI Usage',
                    'Global Human Equality',
                    'Overcoming Climate Change'
                ];
                
                this.init();
            }

            init() {
                this.drawTriangle();
                this.drawLabels();
                this.canvas.addEventListener('click', (e) => this.handleClick(e));
            }

            drawTriangle() {
                const p = this.padding;
                const w = this.size - 2 * p;
                const h = this.height;
                
                // Triangle vertices
                const top = { x: p + w / 2, y: p };
                const left = { x: p, y: p + h };
                const right = { x: p + w, y: p + h };
                
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(top.x, top.y);
                this.ctx.lineTo(left.x, left.y);
                this.ctx.lineTo(right.x, right.y);
                this.ctx.closePath();
                this.ctx.stroke();

                // Grid lines - symmetrical
                this.ctx.strokeStyle = '#ddd';
                this.ctx.lineWidth = 1;
                
                for (let i = 1; i < 10; i++) {
                    const t = i / 10;
                    
                    // Lines parallel to bottom (left-right edge)
                    const p1 = this.lerp(left, right, t);
                    const p2 = this.lerp(left, top, t);
                    const p3 = this.lerp(right, top, t);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(p2.x, p2.y);
                    this.ctx.lineTo(p3.x, p3.y);
                    this.ctx.stroke();
                    
                    // Lines parallel to left edge (left-top)
                    const q1 = this.lerp(left, top, t);
                    const q2 = this.lerp(right, left, t);
                    const q3 = this.lerp(right, top, t);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(q2.x, q2.y);
                    this.ctx.lineTo(q3.x, q3.y);
                    this.ctx.stroke();
                    
                    // Lines parallel to right edge (right-top)
                    const r1 = this.lerp(right, top, t);
                    const r2 = this.lerp(left, right, t);
                    const r3 = this.lerp(left, top, t);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(r2.x, r2.y);
                    this.ctx.lineTo(r3.x, r3.y);
                    this.ctx.stroke();
                }
            }

            lerp(p1, p2, t) {
                return {
                    x: p1.x + (p2.x - p1.x) * t,
                    y: p1.y + (p2.y - p1.y) * t
                };
            }

            drawLabels() {
                const p = this.padding;
                const w = this.size - 2 * p;
                const h = this.height;
                
                this.ctx.fillStyle = '#333';
                this.ctx.font = 'bold 13px Inter, sans-serif';
                this.ctx.textAlign = 'center';
                
                // Top - A
                this.ctx.fillText('A:', p + w / 2, p - 25);
                this.ctx.font = '11px Inter, sans-serif';
                this.ctx.fillText(this.labels[0], p + w / 2, p - 10);
                
                // Bottom left - B (moved closer to center)
                this.ctx.font = 'bold 13px Inter, sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('B:', p + 60, p + h + 15);
                this.ctx.font = '11px Inter, sans-serif';
                const words1 = this.labels[1].split(' ');
                this.ctx.fillText(words1[0] + ' ' + words1[1], p + 60, p + h + 28);
                this.ctx.fillText(words1[2], p + 60, p + h + 40);
                
                // Bottom right - C (moved closer to center)
                this.ctx.font = 'bold 13px Inter, sans-serif';
                this.ctx.fillText('C:', p + w - 60, p + h + 15);
                this.ctx.font = '11px Inter, sans-serif';
                const words2 = this.labels[2].split(' ');
                this.ctx.fillText(words2[0] + ' ' + words2[1], p + w - 60, p + h + 28);
                this.ctx.fillText(words2[2], p + w - 60, p + h + 40);
            }

            isInsideTriangle(x, y) {
                const p = this.padding;
                const w = this.size - 2 * p;
                const h = this.height;
                
                const x1 = p + w / 2, y1 = p;
                const x2 = p, y2 = p + h;
                const x3 = p + w, y3 = p + h;
                
                const d1 = (x - x2) * (y1 - y2) - (x1 - x2) * (y - y2);
                const d2 = (x - x3) * (y2 - y3) - (x2 - x3) * (y - y3);
                const d3 = (x - x1) * (y3 - y1) - (x3 - x1) * (y - y1);
                
                const hasNeg = (d1 < 0) || (d2 < 0) || (d3 < 0);
                const hasPos = (d1 > 0) || (d2 > 0) || (d3 > 0);
                
                return !(hasNeg && hasPos);
            }

            getBarycentricCoords(x, y) {
                const p = this.padding;
                const w = this.size - 2 * p;
                const h = this.height;
                
                const x1 = p + w / 2, y1 = p;
                const x2 = p, y2 = p + h;
                const x3 = p + w, y3 = p + h;
                
                const detT = (y2 - y3) * (x1 - x3) + (x3 - x2) * (y1 - y3);
                const a = ((y2 - y3) * (x - x3) + (x3 - x2) * (y - y3)) / detT;
                const b = ((y3 - y1) * (x - x3) + (x1 - x3) * (y - y3)) / detT;
                const c = 1 - a - b;
                
                return { a, b, c };
            }

            drawPoint(x, y) {
                this.ctx.fillStyle = '#ff4757';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 6, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.strokeStyle = '#fff';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();
            }

            async handleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (!this.isInsideTriangle(x, y)) {
                    this.updateStatus('Please click inside the triangle', 'error');
                    return;
                }
                
                const coords = this.getBarycentricCoords(x, y);
                
                // Redraw
                this.ctx.clearRect(0, 0, this.size, this.size);
                this.drawTriangle();
                this.drawLabels();
                this.drawPoint(x, y);
                
                this.updateStatus('Saving...', '');
                
                await this.saveToSupabase(coords);
            }

            async saveToSupabase(coords) {
                try {
                    const insertData = {
                        year: this.year,
                        ai_usage: Math.round(coords.a * 100),
                        human_equality: Math.round(coords.b * 100),
                        climate_change: Math.round(coords.c * 100),
                        created_at: new Date().toISOString()
                    };
                    
                    console.log('Attempting to insert:', insertData);
                    
                    const { data, error } = await supabase
                        .from('responses')
                        .insert([insertData])
                        .select();
                    
                    if (error) {
                        console.error('Supabase error details:', error);
                        throw error;
                    }
                    
                    console.log('Successfully saved:', data);
                    this.updateStatus('‚úì Your vision has been recorded!', 'success');
                } catch (error) {
                    console.error('Full error:', error);
                    let errorMsg = 'Error saving. ';
                    
                    if (error.message) {
                        errorMsg += error.message;
                    }
                    
                    if (error.code === '42501') {
                        errorMsg = 'Permission denied. Enable RLS policy in Supabase.';
                    } else if (error.code === 'PGRST116') {
                        errorMsg = 'Table not found. Please create the table first.';
                    }
                    
                    this.updateStatus(errorMsg, 'error');
                }
            }

            updateStatus(message, className) {
                this.statusEl.textContent = message;
                this.statusEl.className = 'status ' + className;
            }
        }

        // Initialize both plots
        new TernaryPlot('canvas2025', 2025, 'status2025');
        new TernaryPlot('canvas2075', 2075, 'status2075');
    </script>
</body>
</html>
