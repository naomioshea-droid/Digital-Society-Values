<script>
  function uuid() { return 'anon-' + Math.random().toString(36).slice(2, 10); }
  function normalize(a,b,c){ const s=a+b+c; return [a/s,b/s,c/s]; }
  function pct(x){ return Math.round(x*1000)/10; }

  let USER_ID = localStorage.getItem('values_user_id');
  if(!USER_ID){ USER_ID = uuid(); localStorage.setItem('values_user_id', USER_ID); }

  const values = {
    A:'Maximising AI Usage',
    B:'Global Human Equality',
    C:'Overcoming Climate Change'
  };

  const layout = (title) => ({
    title: { text: title, y: 0.98, pad: { b: 40 } },
    ternary: {
      domain: { x: [0.08, 0.92], y: [0.10, 0.92] },
      sum: 1,
      aaxis: { title: { text: values.A }, min: 0 },
      baxis: { title: { text: values.B }, min: 0 },
      caxis: { title: { text: values.C }, min: 0 }
    },
    margin: { l: 80, r: 80, b: 100, t: 120 }
  });

  function renderPlot(divId,title){
    Plotly.newPlot(divId,[{
      type:'scatterternary',
      a:[], b:[], c:[],
      mode:'markers',
      marker:{size:12, color:'#0f766e'}
    }], layout(title), {displayModeBar:false});
  }

  renderPlot('plotPresent', 'Present (2025)');
  renderPlot('plotFuture',  'Future (2075)');

  const presentStatus=document.getElementById('presentStatus');
  const futureStatus=document.getElementById('futureStatus');
  const presentSubmit=document.getElementById('presentSubmit');
  const futureSubmit=document.getElementById('futureSubmit');
  const presentReset=document.getElementById('presentReset');
  const futureReset=document.getElementById('futureReset');
  let presentPoint=null, futurePoint=null;

  document.getElementById('plotPresent').on('plotly_click', (e)=>{
    const p=e.points?.[0]; if(!p) return;
    let [a,b,c]=normalize(p.a,p.b,p.c);
    presentPoint={a,b,c};
    Plotly.react('plotPresent',[{type:'scatterternary',a:[a],b:[b],c:[c],mode:'markers',marker:{size:14,color:'#0f766e'}}],layout('Present (2025)'));
    presentStatus.innerHTML=`You selected: ${pct(a)}% ${values.A}, ${pct(b)}% ${values.B}, ${pct(c)}% ${values.C}`;
    presentSubmit.disabled=false; presentReset.disabled=false;
  });

  document.getElementById('plotFuture').on('plotly_click', (e)=>{
    const p=e.points?.[0]; if(!p) return;
    let [a,b,c]=normalize(p.a,p.b,p.c);
    futurePoint={a,b,c};
    Plotly.react('plotFuture',[{type:'scatterternary',a:[a],b:[b],c:[c],mode:'markers',marker:{size:14,color:'#0f766e'}}],layout('Future (2075)'));
    futureStatus.innerHTML=`You selected: ${pct(a)}% ${values.A}, ${pct(b)}% ${values.B}, ${pct(c)}% ${values.C}`;
    futureSubmit.disabled=false; futureReset.disabled=false;
  });

  const SUPABASE_URL = 'https://vvsmbbiovppehkydxhmu.supabase.co';
  const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE'; // keep anon key here, not service key!

  async function saveToSupabase(data, statusEl, buttonEl) {
    console.log('Submitting to Supabase:', data);
    statusEl.textContent = 'Submitting…';
    try {
      const resp = await fetch(`${SUPABASE_URL}/rest/v1/responses`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      const text = await resp.text();
      console.log('Supabase status:', resp.status, text);
      if (resp.ok) {
        statusEl.textContent = '✅ Response saved to Supabase!';
        statusEl.classList.add('success');
        buttonEl.disabled = true;
      } else {
        statusEl.textContent = '⚠️ Error saving: ' + text;
        statusEl.classList.add('error');
      }
    } catch (e) {
      console.error('Network/JS error:', e);
      statusEl.textContent = '⚠️ Network/JS error: ' + e.message;
      statusEl.classList.add('error');
    }
  }

  presentSubmit.addEventListener('click', async () => {
    if (!presentPoint) { presentStatus.textContent = 'Please click inside the triangle first.'; return; }
    const data = { user_id: USER_ID, a: presentPoint.a, b: presentPoint.b, c: presentPoint.c, year: 2025 };
    await saveToSupabase(data, presentStatus, presentSubmit);
  });

  futureSubmit.addEventListener('click', async () => {
    if (!futurePoint) { futureStatus.textContent = 'Please click inside the triangle first.'; return; }
    const data = { user_id: USER_ID, a: futurePoint.a, b: futurePoint.b, c: futurePoint.c, year: 2075 };
    await saveToSupabase(data, futureStatus, futureSubmit);
  });

  presentReset.onclick = () => { renderPlot('plotPresent','Present (2025)'); presentStatus.textContent='Click to select again.'; presentSubmit.disabled=true; presentPoint=null; };
  futureReset.onclick = () => { renderPlot('plotFuture','Future (2075)'); futureStatus.textContent='Click to select again.'; futureSubmit.disabled=true; futurePoint=null; };
</script>


